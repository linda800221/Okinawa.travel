<script>
// -------------------------------
// ğŸŒŸ Tabs åˆ‡æ›
// -------------------------------
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
}

// -------------------------------
// ğŸŒŸ è¡Œç¨‹è³‡æ–™å­˜å– localStorage
// -------------------------------
let itinerary = JSON.parse(localStorage.getItem('itineraryData')) || [];

// -------------------------------
// ğŸŒŸ Render è¡Œç¨‹åˆ—è¡¨
// -------------------------------
function renderItinerary() {
    const container = document.getElementById('itinerary-list');
    container.innerHTML = "";

    itinerary.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = "itinerary-item";
        div.draggable = true;

        div.innerHTML = `
            <div class="itinerary-header">
                <span class="drag-handle">â˜°</span>
                <span contenteditable="true" class="item-title" data-index="${index}">
                    ${item.title || "æœªå‘½åè¡Œç¨‹"}
                </span>
                <button onclick="deleteItem(${index})" class="delete-btn">åˆªé™¤</button>
            </div>
            <div class="itinerary-body">
                <label>æ™‚é–“ï¼š</label>
                <input type="text" value="${item.time}" data-index="${index}" data-field="time">

                <label>åœ°é»ï¼š</label>
                <input type="text" value="${item.location}" data-index="${index}" data-field="location">

                <label>ä»‹ç´¹ï¼š</label>
                <textarea data-index="${index}" data-field="desc">${item.desc}</textarea>

                <label>Google Map é€£çµï¼š</label>
                <input type="text" value="${item.map}" data-index="${index}" data-field="map">
            </div>
        `;

        // æ‹–æ›³æ’åº
        div.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", index);
        });

        div.addEventListener("dragover", (e) => e.preventDefault());

        div.addEventListener("drop", (e) => {
            e.preventDefault();
            const from = e.dataTransfer.getData("text/plain");
            const to = index;
            moveItem(from, to);
        });

        container.appendChild(div);
    });

    attachInputListeners();
}

// -------------------------------
// ğŸŒŸ æ–°å¢è¡Œç¨‹
// -------------------------------
function addItem() {
    itinerary.push({
        title: "",
        time: "",
        location: "",
        desc: "",
        map: ""
    });
    saveData();
    renderItinerary();
}

// -------------------------------
// ğŸŒŸ åˆªé™¤è¡Œç¨‹
// -------------------------------
function deleteItem(index) {
    itinerary.splice(index, 1);
    saveData();
    renderItinerary();
}

// -------------------------------
// ğŸŒŸ æ‹–æ›³ç§»å‹•æ’åº
// -------------------------------
function moveItem(from, to) {
    const item = itinerary.splice(from, 1)[0];
    itinerary.splice(to, 0, item);
    saveData();
    renderItinerary();
}

// -------------------------------
// ğŸŒŸ Input å³æ™‚æ›´æ–°
// -------------------------------
function attachInputListeners() {
    document.querySelectorAll("input, textarea, .item-title").forEach(el => {
        el.addEventListener("input", () => {
            const index = el.dataset.index;
            const field = el.dataset.field;

            if (el.classList.contains("item-title")) {
                itinerary[index].title = el.innerText.trim();
            } else {
                itinerary[index][field] = el.value;
            }

            saveData();
        });
    });
}

// -------------------------------
// ğŸŒŸ å­˜å…¥ localStorage
// -------------------------------
function saveData() {
    localStorage.setItem("itineraryData", JSON.stringify(itinerary));
}

// -------------------------------
// ğŸŒŸ åŒ¯ç‡æ›ç®— (å°å¹£ â†” æ—¥å¹£)
// -------------------------------
function setupExchangeCalculator() {
    const twd = document.getElementById("twd");
    const jpy = document.getElementById("jpy");

    function convert(from) {
        const rate = 4.5; // ä½ å¯è‡ªè¨‚åŒ¯ç‡

        if (from === "twd") {
            jpy.value = (twd.value * rate).toFixed(0);
        } else {
            twd.value = (jpy.value / rate).toFixed(0);
        }
    }

    twd.addEventListener("input", () => convert("twd"));
    jpy.addEventListener("input", () => convert("jpy"));
}

// -------------------------------
// ğŸŒŸ åˆå§‹åŒ–
// -------------------------------
document.addEventListener("DOMContentLoaded", () => {
    showTab('tab-itinerary');
    renderItinerary();
    setupExchangeCalculator();
});
</script>
